{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Gestión de Usuarios</h2>
        <button class="btn btn-success" onclick="mostrarModalUsuario()">
            <i class="fas fa-plus"></i> Agregar Usuario
        </button>
    </div>
    
    <!-- Panel de búsqueda y filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="{{ url_for('main.usuarios') }}" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <input type="text" class="form-control" name="search" placeholder="Buscar por nombre o email" value="{{ request.args.get('search', '') }}">
                        <button class="btn btn-primary" type="submit">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="estado">
                        <option value="" {% if not request.args.get('estado') %}selected{% endif %}>Todos los estados</option>
                        <option value="activo" {% if request.args.get('estado') == 'activo' %}selected{% endif %}>Activos</option>
                        <option value="inactivo" {% if request.args.get('estado') == 'inactivo' %}selected{% endif %}>Inactivos</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="rol">
                        <option value="" {% if not request.args.get('rol') %}selected{% endif %}>Todos los roles</option>
                        <option value="pendiente" {% if request.args.get('rol') == 'pendiente' %}selected{% endif %}>Pendientes</option>
                        <option value="usuario" {% if request.args.get('rol') == 'usuario' %}selected{% endif %}>Usuarios</option>
                        <option value="admin" {% if request.args.get('rol') == 'admin' %}selected{% endif %}>Administradores</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <select class="form-select" name="tipo_suscripcion">
                        <option value="" {% if not request.args.get('tipo_suscripcion') %}selected{% endif %}>Todas las suscripciones</option>
                        <option value="gratuito" {% if request.args.get('tipo_suscripcion') == 'gratuito' %}selected{% endif %}>Gratuito</option>
                        <option value="premium" {% if request.args.get('tipo_suscripcion') == 'premium' %}selected{% endif %}>Premium</option>
                    </select>
                </div>
                <div class="col-md-1">
                    <a href="{{ url_for('main.usuarios') }}" class="btn btn-secondary w-100">Limpiar</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de usuarios -->
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead class="table-primary">
                <tr>
                    <th>ID</th>
                    <th>Nombre</th>
                    <th>Email</th>
                    <th>Estado</th>
                    <th>Rol</th>
                    <th>Tipo Suscripción</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios %}
                <tr>
                    <td>{{ usuario.id }}</td>
                    <td>{{ usuario.nombre }}</td>
                    <td>{{ usuario.email }}</td>
                    <td>
                        <span class="badge {% if usuario.activo %}bg-success{% else %}bg-danger{% endif %}">
                            {{ 'Activo' if usuario.activo else 'Inactivo' }}
                        </span>
                    </td>
                    <td>
                        <span class="badge {% if usuario.rol == 'pendiente' %}bg-warning{% elif usuario.rol == 'admin' %}bg-info{% else %}bg-success{% endif %}">
                            {{ usuario.rol | title }}
                        </span>
                    </td>
                    <td>
                        <span class="badge {% if usuario.tipo_suscripcion == 'premium' %}premium-badge{% else %}bg-secondary{% endif %}">
                            {{ usuario.tipo_suscripcion | title }}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editarUsuario({{ usuario.id }})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm {% if usuario.activo %}btn-danger{% else %}btn-success{% endif %}" 
                                onclick="toggleEstadoUsuario({{ usuario.id }}, {{ usuario.activo|tojson }})">
                            <i class="fas {% if usuario.activo %}fa-user-slash{% else %}fa-user-check{% endif %}"></i>
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginación -->
    {% if total_pages > 1 %}
    <nav aria-label="Navegación de páginas">
        <ul class="pagination justify-content-center">
            {% set args = request.args.copy() %}
            {% set _ = args.pop('page', None) %}
            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('main.usuarios', page=page-1, **args) if page > 1 else '#' }}">&laquo;</a>
            </li>
            {% for p in range(1, total_pages + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
                <a class="page-link" href="{{ url_for('main.usuarios', page=p, **args) }}">{{ p }}</a>
            </li>
            {% endfor %}
            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('main.usuarios', page=page+1, **args) if page < total_pages else '#' }}">&raquo;</a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal de Usuario -->
<div class="modal fade" id="modalUsuario" tabindex="-1" aria-labelledby="modalUsuarioLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalUsuarioLabel">Usuario</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formUsuario" onsubmit="guardarUsuario(event)">
                    <input type="hidden" id="usuario_id" name="id">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email *</label>
                        <input type="email" class="form-control" id="email" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="nombre" class="form-label">Nombre</label>
                        <input type="text" class="form-control" id="nombre" name="nombre">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">Contraseña</label>
                        <input type="password" class="form-control" id="password" name="password">
                        <small class="text-muted">Dejar en blanco para mantener la contraseña actual al editar</small>
                    </div>
                    <div class="mb-3">
                        <label for="tipo_suscripcion" class="form-label">Tipo de Suscripción</label>
                        <select class="form-select" id="tipo_suscripcion" name="tipo_suscripcion">
                            <option value="gratuito">Gratuito</option>
                            <option value="premium">Premium</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="activo" name="activo" checked>
                            <label class="form-check-label" for="activo">Usuario Activo</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Scripts para las acciones de usuario -->
<script>
function mostrarModalUsuario(usuario = null) {
    const modal = new bootstrap.Modal(document.getElementById('modalUsuario'));
    const form = document.getElementById('formUsuario');
    const titulo = document.getElementById('modalUsuarioLabel');

    // Limpiar formulario
    form.reset();
    document.getElementById('usuario_id').value = '';

    if (usuario) {
        titulo.textContent = 'Editar Usuario';
        document.getElementById('usuario_id').value = usuario.id;
        document.getElementById('email').value = usuario.email;
        document.getElementById('nombre').value = usuario.nombre || '';
        document.getElementById('tipo_suscripcion').value = usuario.tipo_suscripcion;
        document.getElementById('activo').checked = usuario.activo;
    } else {
        titulo.textContent = 'Agregar Usuario';
    }

    modal.show();
}

function editarUsuario(id) {
    fetch(`/usuarios/${id}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                mostrarModalUsuario(data.usuario);
            } else {
                alert('Error al cargar datos del usuario');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al cargar datos del usuario');
        });
}

function guardarUsuario(event) {
    event.preventDefault();
    const formData = new FormData(event.target);
    
    fetch('/usuarios/guardar', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalUsuario'));
            modal.hide();
            window.location.reload();
        } else {
            alert(data.message || 'Error al guardar usuario');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al guardar usuario');
    });
}

function toggleEstadoUsuario(id, estadoActual) {
    if (confirm('¿Estás seguro de que deseas cambiar el estado de este usuario?')) {
        fetch(`/usuarios/${id}/toggle-estado`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error al cambiar el estado del usuario');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error al procesar la solicitud');
        });
    }
}
</script>
{% endblock %}